---
title: "pfas"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
```

```{r}
pfas_df = read_excel("./data/wtc_pfas_results.xlsx",
          sheet = "PFAAs",
          skip = 4, 
          col_names = TRUE) |> 
  janitor::clean_names() |> 
  mutate(
    pfos = ifelse(pfos == "<LOQ", 0.10, pfos),
    pfoa = ifelse(pfoa == "<LOQ", 0.04, pfoa),
    pfbs = ifelse(pfbs == "<LOQ", 0.04, pfbs),
    pf_hx_s = ifelse(pf_hx_s == "<LOQ", 0.04, pf_hx_s),
    pfds = ifelse(pfds == "<LOQ", 0.04, pfds),
    pfosa = ifelse(pfosa == "<LOQ", 0.04, pfosa),
    pf_hx_a = ifelse(pf_hx_a == "<LOQ", 0.04, pf_hx_a),
    pf_hp_a = ifelse(pf_hp_a == "<LOQ", 0.04, pf_hp_a),
    pfda = ifelse(pfda == "<LOQ", 0.04, pfda),
    pf_un_da = ifelse(pf_un_da == "<LOQ", 0.10, pf_un_da),
    pf_do_da = ifelse(pf_do_da == "<LOQ", 0.10, pf_do_da),
    pfna = ifelse(pfna == "<LOQ", 0.10, pfna)
  ) |>
  mutate(across(pfos:pfna, as.numeric)) |> 
  rename(sid = subject_id) |> 
  mutate(sid = as.numeric(sid) %% 1000)


      

pfas_df = pfas_df[1:(nrow(pfas_df) - 4), ]
view(pfas_df)

write_csv(pfas_df, "wtc_pfas.csv")
```

```{r}
maternal_df = pfas_df |> 
  filter(startsWith(as.character(sid), "1")) |> 
  mutate(sid = as.numeric(sid) %% 1000)
view(maternal_df)

cord_df = pfas_df |> 
  filter(startsWith(as.character(sid), "2")) |> 
  mutate(sid = as.numeric(sid) %% 1000)
view(cord_df)
```

```{r}
summary(pfas_df[ , c("pfos", "pfoa", "pfbs", "pf_hx_s", "pfds", "pfosa", "pf_hx_a", "pf_hp_a", "pfda", "pf_un_da", "pf_do_da", "pfna")])

summary(maternal_df[ , c("pfos", "pfoa", "pfbs", "pf_hx_s", "pfds", "pfosa", "pf_hx_a", "pf_hp_a", "pfda", "pf_un_da", "pf_do_da", "pfna")])

summary(cord_df[ , c("pfos", "pfoa", "pfbs", "pf_hx_s", "pfds", "pfosa", "pf_hx_a", "pf_hp_a", "pfda", "pf_un_da", "pf_do_da", "pfna")])
```

```{r}
ggplot(pfas_df, aes(x = pfos)) +
  geom_histogram(binwidth = 1) +
  theme_minimal()

ggplot(maternal_df, aes(x = pfos)) +
  geom_histogram(binwidth = 1) +
  theme_minimal()

ggplot(cord_df, aes(x = pfos)) +
  geom_histogram(binwidth = 1) +
  theme_minimal()
```





```{r}
maternal_df = maternal_df |> 
  mutate(sample_type = "Maternal")
cord_df = cord_df |> 
  mutate(sample_type = "Cord")
```

```{r}
combined_df = bind_rows(maternal_df, cord_df)
```

```{r}
pfas_long = combined_df |> 
  pivot_longer(cols = pfos:pfna, 
               names_to = "pfas", 
               values_to = "concentration")
```

```{r}
ggplot(pfas_long, aes(x = concentration, fill = sample_type)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30) +
  facet_wrap(~pfas, scales = "free") +
  scale_fill_manual(values = c("Maternal" = "steelblue", "Cord" = "tomato")) +
  theme_minimal() +
  labs(x = "Concentration", y = "Count", fill = "Sample Type",
       title = "Distribution of PFAS in Maternal vs Cord Samples")
```



```{r}
demographic_df = read_csv("./data/wtc_demographic.csv") |> 
  janitor::clean_names() |> 
  mutate(sid = sid %% 1000) |> 
  filter(m_age >= 18, m_age < 40) |> 
  filter(family_smoking != 1) |> 
  filter(parity != "", !is.na(parity)) |> 
  filter(m_race != "", !is.na(m_race)) |> 
  filter(bmi_cat_new != "", !is.na(bmi_cat_new)) |> 
  filter(hosp != 1)





view(demographic_df)
write_csv(demographic_df, "m_demographic.csv")
```



```{r}
m_pfas = inner_join(pfas_df, demographic_df, by = "sid")
view(m_pfas)

write_csv(demographic_df, "m_pfas.csv")
```



```{r}
demo_summary <- m_pfas %>%
  mutate(
    gender = factor(gender, labels = c("Male", "Female")),
    c_section = factor(c_section, labels = c("No", "Yes")),
    nicu = factor(nicu, labels = c("No", "Yes")),
    edu = factor(edu, labels = c("≤High School", "Some College", "College+")),
    marital = factor(marital, labels = c("Single", "Married")),
    bmi_cat_new = factor(bmi_cat_new, labels = c("Underweight/Normal", "Overweight", "Obese")),
    everbf = factor(everbf, labels = c("No", "Yes")),
    medicaid = factor(medicaid, labels = c("No", "Yes"))
  ) |> 
  select(
    "Infant Gender" = gender, 
    "Mother Age" = m_age, 
    "Maternal BMI Category" = bmi_cat_new, 
    "Maternal Education Level" = edu, 
    "Maternal Marital Status" = marital, 
    "Number of Previous Births" = parity, 
    "NICU Admission" = nicu, 
    "C-Section Delivery" = c_section, 
    "Ever Breastfed" = everbf, 
    "Medicaid" = medicaid) %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    missing = "no"
  ) %>%
  modify_header(label ~ "**Variable**") %>%
  bold_labels()

demo_summary
```




```{r}
pfas_summary = m_pfas |> 
  select(
    PFOS = pfos,
    PFOA = pfoa,
    PFBS = pfbs,
    PFHxS = pf_hx_s,
    PFDS = pfds,
    PFOSA = pfosa,
    PFHxA = pf_hx_a,
    PFHpA = pf_hp_a,
    PFDA = pfda,
    PFUnDA = pf_un_da,
    PFDoDA = pf_do_da,
    PFNA = pfna
  ) |> 
  tbl_summary(
    statistic = all_continuous() ~ "{mean} ({sd})",
    missing = "no"
  ) |> 
  modify_header(label ~ "**PFAS Compound**") |> 
  modify_spanning_header(all_stat_cols() ~ "**PFAS Exposure (ng/mL)**") |> 
  bold_labels()
```







```{r}
lipids_df = read_excel("./data/lipids.xls",
            sheet = "Final Data",
            skip = 1, 
            col_names = TRUE) |> 
  janitor::clean_names() |> 
  mutate(sample_id = as.numeric(sub("^T", "", sample_id))) |> 
  mutate(sample_id = sample_id %% 1000) |> 
  rename(sid = sample_id) |> 
  drop_na()

view(lipids_df)
```

```{r}
m_lipids = inner_join(m_pfas, lipids_df, by = "sid")

view(m_lipids)
```


```{r}
pfas_df = pfas_df |>
  mutate(sid = as.numeric(sid))
demographic_df = demographic_df |>
  mutate(sid = as.numeric(sid))

merged_df = demographic_df |> 
  inner_join(lipids_df, by = "sid")
view(merged_df)
```


Correlation Matrix
```{r}
# Select only PFAS numeric columns
pfas_vars = c("pfos", "pfoa", "pfbs", "pf_hx_s", "pfds", "pfosa",
               "pf_hx_a", "pf_hp_a", "pfda", "pf_un_da", "pf_do_da", "pfna")

# Maternal correlation matrix
maternal_cor = cor(maternal_df[, pfas_vars], use = "pairwise.complete.obs", method = "pearson")
view(maternal_cor)

# Cord correlation matrix
cord_cor = cor(cord_df[, pfas_vars], use = "pairwise.complete.obs", method = "pearson")
view(cord_cor)
```

```{r}
library(corrplot)

corrplot(maternal_cor, method = "color", type = "lower",
         addCoef.col = "black", tl.col = "black", tl.srt = 45,
         title = "Maternal PFAS Correlations", mar = c(0,0,2,0))

corrplot(cord_cor, method = "color", type = "lower",
         addCoef.col = "black", tl.col = "black", tl.srt = 45,
         title = "Cord PFAS Correlations", mar = c(0,0,2,0))
```

```{r}
library(dplyr)
library(tidyr)

combined_cor = combined_df |>
  select(sample_type, all_of(pfas_vars)) |>
  group_by(sample_type) |>
  summarise(across(everything(), ~list(.)), .groups = "drop") |>
  rowwise() |>
  mutate(cor_matrix = list(cor(as.data.frame(across(where(is.list), ~ unlist(.))),
                               use = "pairwise.complete.obs"))) |>
  select(sample_type, cor_matrix)
```




Heatmap
```{r}
pfas_vars <- c("pfos", "pfoa", "pfbs", "pf_hx_s", "pfds", "pfosa",
               "pf_hx_a", "pf_hp_a", "pfda", "pf_un_da", "pf_do_da", "pfna")

maternal_cor <- cor(maternal_df[, pfas_vars], use = "pairwise.complete.obs")
cord_cor     <- cor(cord_df[, pfas_vars], use = "pairwise.complete.obs")
```

```{r}
library(reshape2)
library(dplyr)

maternal_long <- melt(maternal_cor) |> 
  mutate(sample_type = "Maternal")

cord_long <- melt(cord_cor) |> 
  mutate(sample_type = "Cord")

cor_long <- bind_rows(maternal_long, cord_long)
```

```{r}
library(ggplot2)

ggplot(cor_long, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red",
                       midpoint = 0, limit = c(-1, 1)) +
  facet_wrap(~sample_type) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "PFAS Correlations in Maternal vs Cord Samples",
       x = "", y = "", fill = "Correlation")
```

```{r}
pfas_vars <- c("pfos", "pfoa", "pfbs", "pf_hx_s", "pfds", "pfosa",
               "pf_hx_a", "pf_hp_a", "pfda", "pf_un_da", "pf_do_da", "pfna")

maternal_cor <- cor(maternal_df[, pfas_vars], use = "pairwise.complete.obs")
cord_cor     <- cor(cord_df[, pfas_vars], use = "pairwise.complete.obs")

# Difference (Maternal minus Cord)
diff_cor <- maternal_cor - cord_cor

library(reshape2)
diff_long <- melt(diff_cor)

library(ggplot2)

ggplot(diff_long, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red",
                       midpoint = 0, limit = c(-1, 1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "Difference in PFAS Correlations (Maternal − Cord)",
       x = "", y = "", fill = "Change Correlation")
```
Red represents strong correlations in maternal samples, blue represents strong correlations in cord samples, and white is similar in both.
